# Implementation Plan

## Task Breakdown

### 1. errorイベント処理機能の実装
- [x] 1.1 testErrorsマップの追加
  - `_parseEvents`メソッド内に`testErrors`マップ（`Map<int, Map<String, String?>>`）を追加
  - errorイベント情報を`testID`でグループ化して保存するためのデータ構造
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 1.2 _processErrorEventメソッドの実装
  - errorイベントから`testID`、`error`、`stackTrace`フィールドを取得
  - `testID`が存在しない場合、イベントを無視（エラーを発生させない）
  - `error`フィールドが存在しない場合、nullとして扱う
  - `stackTrace`フィールドが存在しない場合、nullとして扱う
  - `isFailure`フィールドは無視する
  - エラー情報を`testErrors`マップに保存（`testID`でグループ化）
  - 複数のerrorイベントが同じ`testID`に対して発生する場合、最後のイベントの情報を使用（上書き）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 1.10, 2.1, 2.2, 2.3, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 5.10_

- [x] 1.3 _parseEventsメソッドの修正
  - `switch`文に`case 'error':`を追加
  - `_processErrorEvent`メソッドを呼び出す
  - `testErrors`マップを`_processTestDoneEvent`メソッドに渡す
  - _Requirements: 1.1, 2.1_

- [x] 1.4 _processTestDoneEventメソッドの修正
  - `testErrors`マップをパラメータとして受け取る
  - `testDone`イベントの`error`フィールドと`stackTrace`フィールドを取得
  - `testErrors`マップから対応する`testID`のエラー情報を取得
  - `testDone`イベントの`error`フィールドが存在する場合、それを優先（errorイベントの情報より優先）
  - `testDone`イベントの`error`フィールドが存在しない場合、errorイベントから取得したエラー情報を使用
  - `testDone`イベントの`stackTrace`フィールドが存在する場合、それを優先（errorイベントの情報より優先）
  - `testDone`イベントの`stackTrace`フィールドが存在しない場合、errorイベントから取得したスタックトレース情報を使用
  - 取得したエラー情報をTestCaseコンストラクタに渡す
  - `testDone`イベント処理後、使用済みのエラー情報を削除（メモリ効率のため）
  - _Requirements: 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 6.5_

### 2. ユニットテストの実装
- [x] 2.1 errorイベントの処理テスト
  - `error`イベントが存在し、`testID`が有効な場合、エラー情報が保存されることを確認
  - `error`イベントの`testID`が存在しない場合、イベントが無視されることを確認
  - `error`イベントの`error`フィールドが存在しない場合、nullとして扱われることを確認
  - `error`イベントの`stackTrace`フィールドが存在しない場合、nullとして扱われることを確認
  - `error`イベントの`isFailure`フィールドが無視されることを確認
  - 複数のerrorイベントが同じ`testID`に対して発生する場合、最後のイベントの情報が使用されることを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 1.10_

- [x] 2.2 errorイベント情報の保存と取得テスト
  - `error`イベントから取得したエラー情報が`testID`でグループ化されて保存されることを確認
  - `testDone`イベント時に、保存されたエラー情報が取得されることを確認
  - `testDone`イベントの`error`フィールドが存在する場合、それが優先されることを確認
  - `testDone`イベントの`error`フィールドが存在しない場合、errorイベントから取得したエラー情報が使用されることを確認
  - `testDone`イベント処理後、使用済みのエラー情報が削除されることを確認
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10_

- [x] 2.3 TestCaseへのエラー情報の設定テスト
  - `error`イベントから取得したエラー情報がTestCaseに設定されることを確認
  - エラーメッセージが複数行を含む場合、そのまま保持されることを確認
  - スタックトレースが複数行を含む場合、そのまま保持されることを確認
  - テストケースのステータスが`failed`の場合、エラーメッセージが設定されていることを確認（TestCase.isValidの要件）
  - テストケースのステータスが`error`の場合、エラーメッセージが設定されていることを確認（TestCase.isValidの要件）
  - テストケースのステータスが`passed`または`skipped`の場合、エラーメッセージがnullでも問題ないことを確認
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9_

- [x] 2.4 後方互換性テスト
  - `error`イベントが存在しないJSONが正常に処理されることを確認
  - `testDone`イベントに`error`フィールドが含まれている場合、従来通りそれを使用することを確認
  - 既存のテストケースの動作（passed、failed、skipped）に影響がないことを確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [x] 2.5 エッジケーステスト
  - `error`イベントの`testID`が存在しない場合、イベントが無視されることを確認
  - `error`イベントの`testID`に対応する`_TestInfo`が見つからない場合でも、エラー情報が保存されることを確認
  - `error`イベントの`error`フィールドが空文字列の場合、nullとして扱われることを確認
  - `error`イベントの`stackTrace`フィールドが空文字列の場合、nullとして扱われることを確認
  - `error`イベントの`error`フィールドが数値やbool等の非文字列型の場合、適切に処理されることを確認
  - `testDone`イベントが`error`イベントより前に発生する場合、testDoneイベントの`error`フィールドが使用されることを確認
  - `error`イベントの`error`フィールドに改行文字（`\n`）が含まれている場合、そのまま保持されることを確認
  - `error`イベントの`stackTrace`フィールドに改行文字（`\n`）が含まれている場合、そのまま保持されることを確認
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 5.10_

### 3. 統合テストの実装
- [x] 3.1 エンドツーエンドテスト: errorイベントの処理
  - JSON入力にerrorイベントが含まれ、`testDone`イベントに`error`フィールドが含まれていない場合、XML出力にエラー情報が含まれることを確認
  - 複数のテストケースがある場合、それぞれのテストケースにエラー情報が正しく設定されることを確認
  - `testDone`イベントに`error`フィールドが含まれている場合、それが優先されることを確認
  - _Requirements: 1.1, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 2.10, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9_

- [x] 3.2 CLI統合テスト: errorイベントの処理
  - errorイベントを含むJSONを処理した場合、正常にXMLが生成されることを確認
  - 既存のCI/CDツールとの互換性を確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

### 4. パフォーマンステスト（オプショナル）
- [ ] 4.1 大規模テストスイートでのパフォーマンステスト
  - 10,000件のテストケースにerrorイベントが含まれる場合の処理時間を測定
  - errorイベントの処理によるオーバーヘッドが最小限であることを確認
  - メモリ使用量が適切に管理されることを確認
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

## Implementation Notes

### 実装状況
- タスク1.1-1.4は既に実装済み（`lib/src/parser/dart_test_parser.dart`）
- タスク2.1-2.5、3.1-3.2、4.1は未実装（テストコードの追加が必要）

### 実装の優先順位
1. **高優先度**: タスク2.1-2.3（ユニットテストの実装）
2. **中優先度**: タスク2.4-2.5（後方互換性とエッジケースのテスト）
3. **低優先度**: タスク3.1-3.2（統合テスト）、4.1（パフォーマンステスト）

### テストデータ
- `tests_report_4.json`にerrorイベントが含まれているため、これをテストデータとして使用可能
- 必要に応じて、追加のテストデータを生成

