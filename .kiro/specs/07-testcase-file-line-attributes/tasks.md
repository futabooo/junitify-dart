# Implementation Plan

## Task Breakdown

### 1. TestCaseモデルの拡張
- [x] 1.1 TestCaseクラスにfileとlineフィールドを追加
  - `file`フィールドを`String?`型で追加
  - `line`フィールドを`int?`型で追加
  - コンストラクタにオプショナルパラメータ`file`と`line`を追加
  - `equals`メソッドに`file`と`line`を含める
  - `hashCode`メソッドに`file`と`line`を含める
  - `toString`メソッドに`file`と`line`を含める（オプショナル）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.7, 1.8_

### 2. Parser実装の修正
- [x] 2.1 _TestInfoクラスにfileとlineフィールドを追加
  - `_TestInfo`クラスに`file`フィールド（`String?`型）を追加
  - `_TestInfo`クラスに`line`フィールド（`int?`型）を追加
  - コンストラクタにオプショナルパラメータ`file`と`line`を追加
  - _Requirements: 2.8, 2.10_

- [x] 2.2 URLからファイルパスへの変換関数を追加
  - `_extractFilePathFromUrl`プライベートメソッドを追加
  - `file://`形式のURIをファイルパスに変換する処理
  - `file://`で始まらない場合、nullを返す
  - 絶対パスから相対パスへの変換を試みる（可能な場合）
  - エッジケースの処理（空文字列、null、不正な形式等）
  - _Requirements: 2.3, 2.4, 2.5, 5.1, 5.2, 5.5, 6.5_

- [x] 2.3 _processTestStartEventメソッドを修正してfileとline情報を取得
  - `testStart`イベントの`test`オブジェクトから`url`フィールドを取得
  - `testStart`イベントの`test`オブジェクトから`line`フィールドを取得
  - `url`が`file://`形式の場合、`_extractFilePathFromUrl`でファイルパスに変換
  - `line`が数値の場合、そのまま使用
  - `line`が負の値の場合、nullとして扱う
  - `line`が0の場合、有効な値として扱う
  - `line`が文字列形式で数値が含まれている場合、数値に変換
  - `line`が数値でない型の場合、nullとして扱う
  - 取得した`file`と`line`を`_TestInfo`に保存
  - `test`オブジェクトが存在しない、または必要なフィールドが存在しない場合は無視
  - 複数のtestStartイベントが同じテストIDに対して発生する場合、最初のイベントの情報を使用
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.9, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 6.1_

- [x] 2.4 _processTestDoneEventメソッドを修正してTestCaseにfileとlineを設定
  - `testDone`イベント処理時に、対応する`testID`の`_TestInfo`から`file`と`line`を取得
  - `file`と`line`が存在する場合、TestCaseコンストラクタに渡す
  - `file`と`line`がnullの場合、TestCaseコンストラクタにnullを渡す
  - _Requirements: 2.10, 4.1, 4.2_

### 3. XMLジェネレーターの修正
- [x] 3.1 DefaultJUnitXmlGeneratorの_buildTestCaseメソッドを修正
  - `file`が`null`でない場合、`<testcase>`要素に`file`属性を生成
  - `line`が`null`でない場合、`<testcase>`要素に`line`属性を生成
  - `file`が`null`の場合、`file`属性を生成しない
  - `line`が`null`の場合、`line`属性を生成しない
  - `file`と`line`属性を既存の属性（name、classname、time等）と共に出力
  - `builder.attribute()`メソッドを使用して属性を設定（XMLエスケープは自動処理）
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 3.10_

### 4. ユニットテストの実装
- [ ] 4.1 TestCaseモデルのfileとlineフィールドのテスト
  - `file`が`null`の場合の動作を確認
  - `line`が`null`の場合の動作を確認
  - `file`が有効な値の場合の動作を確認
  - `line`が有効な値の場合の動作を確認
  - `equals`メソッドで`file`と`line`が正しく比較されることを確認
  - `hashCode`メソッドで`file`と`line`が正しく含まれることを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.8_

- [ ] 4.2 URLからファイルパスへの変換関数のテスト
  - `file://`形式のURIがファイルパスに変換されることを確認
  - `file:///home/user/project/test.dart` → `/home/user/project/test.dart`または相対パス
  - `file://`で始まらない場合、nullが返されることを確認
  - `http://`、`https://`等のURLがnullとして扱われることを確認
  - 空文字列がnullとして扱われることを確認
  - nullがnullとして扱われることを確認
  - _Requirements: 2.3, 2.4, 2.5, 5.1, 5.2, 5.5_

- [ ] 4.3 パーサーでのtestStartイベント処理のテスト
  - `testStart`イベントが存在し、`url`と`line`が有効な場合、対応するテストケースの`file`と`line`に含まれることを確認
  - `url`が`file://`形式の場合、ファイルパスに変換されることを確認
  - `url`が`file://`で始まらない場合、`file`がnullのままであることを確認
  - `line`が数値の場合、そのまま使用されることを確認
  - `line`が負の値の場合、`line`がnullのままであることを確認
  - `line`が0の場合、有効な値として扱われることを確認
  - `url`がnullまたは空文字列の場合、`file`がnullのままであることを確認
  - `line`が文字列形式で数値が含まれている場合、数値に変換されることを確認
  - `line`が数値でない型の場合、`line`がnullのままであることを確認
  - 複数のtestStartイベントが同じテストIDに対して発生する場合、最初のイベントの情報が使用されることを確認
  - `test`オブジェクトが存在しない場合、イベントが無視されることを確認
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.9, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8_

- [ ] 4.4 XMLジェネレーターでのfileとline属性生成のテスト
  - `file`が`null`でない場合、`<testcase>`要素に`file`属性が生成されることを確認
  - `line`が`null`でない場合、`<testcase>`要素に`line`属性が生成されることを確認
  - `file`が`null`の場合、`file`属性が生成されないことを確認
  - `line`が`null`の場合、`line`属性が生成されないことを確認
  - XMLエスケープが適切に処理されることを確認（&lt;, &gt;, &amp;等）
  - `file`と`line`属性が既存の属性と共に出力されることを確認
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 3.10_

- [ ] 4.5 後方互換性のテスト
  - `testStart`イベントに`url`または`line`フィールドが存在しないJSONが正常に処理されることを確認
  - 既存のテストケースの動作に影響がないことを確認
  - `file`と`line`が`null`の場合、XML出力が従来通りであることを確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

- [ ] 4.6 パフォーマンステスト
  - 大量のtestStartイベントが存在する場合の処理時間を測定
  - URLからファイルパスへの変換が効率的であることを確認
  - テストケースごとのfileとline情報の保持が効率的であることを確認
  - メモリ使用量が適切に管理されることを確認
  - 10,000件のテストケースを10秒以内に処理できることを確認
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

### 5. 統合テストの実装
- [ ] 5.1 エンドツーエンドテスト: fileとline属性の生成
  - JSON入力にtestStartイベントが含まれ、`url`と`line`が有効な場合、XML出力に各テストケースの`file`と`line`属性が含まれることを確認
  - 複数のテストケースがある場合、それぞれのテストケースに`file`と`line`属性が生成されることを確認
  - `url`が`file://`で始まらない場合、`file`属性が生成されないことを確認
  - `line`が無効な値の場合、`line`属性が生成されないことを確認
  - JUnit XMLスキーマに準拠していることを確認
  - 既存のCI/CDツールとの互換性を確認
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 3.10_

- [ ] 5.2 CLI統合テスト: testStartイベントの処理
  - testStartイベントを含むJSONを処理した場合、正常にXMLが生成されることを確認
  - 既存のCLI機能に影響がないことを確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

## Requirements Coverage Matrix

| Requirement | Tasks |
|-------------|-------|
| 1.1-1.8 | TestCaseにfileとlineフィールド追加 | 1.1, 4.1 |
| 2.1-2.10 | testStartイベントからfileとline情報の取得 | 2.1, 2.2, 2.3, 2.4, 4.2, 4.3 |
| 3.1-3.10 | testcase要素にfileとline属性生成 | 3.1, 4.4 |
| 4.1-4.7 | 後方互換性の維持 | 2.4, 4.5 |
| 5.1-5.8 | エッジケースの処理 | 2.2, 2.3, 4.2, 4.3 |
| 6.1-6.5 | パフォーマンスへの影響最小化 | 2.2, 2.3, 4.6 |

## Implementation Notes

### 実装順序の推奨
1. **フェーズ1**: TestCaseモデルの拡張（1.1）
2. **フェーズ2**: _TestInfoクラスの拡張（2.1）
3. **フェーズ3**: URLからファイルパスへの変換関数の実装（2.2）
4. **フェーズ4**: パーサーの修正（2.3、2.4）
5. **フェーズ5**: XMLジェネレーターの修正（3.1）
6. **フェーズ6**: ユニットテストの実装（4.1-4.6）
7. **フェーズ7**: 統合テストの実装（5.1、5.2）

### 実装上の注意事項
- `file`と`line`フィールドはオプショナルとして実装し、後方互換性を維持する
- URLからファイルパスへの変換は`dart:io`の`Uri`クラスを使用
- エッジケースの処理を適切に行い、エラーを発生させない設計にする
- パフォーマンスへの影響を最小限に抑える（効率的なデータ構造を使用）
- 既存のテストケースがすべて正常に動作することを確認

### テスト戦略
- ユニットテスト: 各コンポーネントの機能を個別にテスト
- 統合テスト: エンドツーエンドでの動作確認
- 回帰テスト: 既存のテストケースがすべて正常に動作することを確認
- パフォーマンステスト: 大規模テストスイートでの性能確認

### 依存関係
- タスク2.3はタスク2.1とタスク2.2に依存
- タスク2.4はタスク2.1とタスク2.3に依存
- タスク3.1はタスク1.1に依存
- タスク4.1はタスク1.1に依存
- タスク4.2はタスク2.2に依存
- タスク4.3はタスク2.3とタスク2.4に依存
- タスク4.4はタスク3.1に依存
- タスク5.1はタスク3.1に依存
- タスク5.2はタスク2.4に依存

